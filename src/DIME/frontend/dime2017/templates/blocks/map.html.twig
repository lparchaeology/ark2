{# Define the map block #}
{% block map %}

<div class = "mapview">

    <link rel="stylesheet" href="https://openlayers.org/en/v3.20.1/css/ol.css" type="text/css">
    <div class="btn-group dropdown map layer-select">
        <button class="btn btn-default dropdown-toggle layer-select" type="button" id="mapLayerMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
            <span class="dime-icon icon-map small"></span>
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu layer-select" aria-labelledby="mapLayerMenu">
            {% for layer in layout.map.layers %}
                {% if layer.isDefault %}
                    <li><a class="layer-select selected" value="{{ layer.name }}">{{ layer.keyword | translate }}</a></li>
                {% else %}
                    <li><a class="layer-select" value="{{ layer.name }}">{{ layer.keyword | translate }}</a></li>
                {% endif %}
            {% endfor %}
        </ul>
    </div>
    <div class="btn-group dropdown map style-select">
        <button class="btn btn-default dropdown-toggle style-select" type="button" id="mapStyleMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
            <span class="dime-icon icon-heatmap small"></span>
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu style-select" aria-labelledby="mapStyleMenu">
            {% if global.user %}
                <li><a class="style-select-option" value="distribution">{{ 'map.style.distribution' | translate }}</a></li>
            {% endif %}
            <li><a class="style-select-option" value="choropleth">{{ 'map.style.choropleth' | translate }}</a></li>
        </ul>
    </div>

    <div id="map" class="map search_map"></div>

    <div id="map-legend" class="map-legend">
    <span class="map-legend-label">{{ 'map.legend.max' | translate }}</span>
    <div class="legend-image"></div>
    <span class="map-legend-label">{{ 'map.legend.min' | translate }}</span>
    </div>

        <script src="https://openlayers.org/en/v3.20.1/build/ol.js"></script>

        <script>

            var layerConfig = [

                {% for layer in layout.map.layers %}
                    {
                        name: {{ layer.name }},
                        visible: {{ layer.isVisible }},
                        preload: Infinity,
                        class: {{ layer.viewClass }},
                        source: {
                            {% if layer.viewClass == 'BingMaps' %}
                                key: {{ layer.source.ticket }},
                                imagerySet: {{ layer.sourceName }}
                            {% endif %}
                            {% if layer.viewClass == 'TileWMS' %}
                                url: '{{ layer.source.url }}&ticket={{ data['kortforsyningenticket'] | raw }}&',
                                parameters: {{ layer.source.parameters }},
                                imagerySet: {{ layer.sourceName }}
                            {% endif %}
                        }
                    },
                {% endfor %}
            ];

            ywkts = [];

            twkts = [];

            {% if global.user %}

                var default_overlay = "distribution";

                {% for item in data[layout.name] %}
                    {% set findpoint = item.property('findpoint').value() %}
                    {% if findpoint['coordinates'] is defined %}
                        ywkts[{{ item.id }}] = '{{ findpoint['coordinates'] }}';
                    {% else %}
                        'POINT (0 0)';
                    {% endif %}
                {% endfor %}

            {% else %}

                var default_overlay = "choropleth";

            {% endif %}


        </script>

    </div>

</div>

{% endblock map %}
